<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>공연 목록 조회 (관리자)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tickethub: {
              DEFAULT: '#FF6F3C',
              dark: '#e65b25'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen py-10 px-4">
<div class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl p-10">
  <h1 class="text-3xl font-bold text-center text-tickethub mb-8">공연 목록 조회 (관리자)</h1>

  <form id="filterForm" action="/admin/performances"
        class="flex flex-wrap gap-4 items-center justify-end mb-8">
    <label class="flex items-center gap-1">
      <input type="radio" name="filter" id="latest" value="latest"
             th:checked="${((param.sort == null or param.sort[0] == 'latest') and param.startDate == null and param.category == null)}">
      <span class="text-sm">Latest</span>
    </label>
    <label class="flex items-center gap-1">
      <input type="radio" name="filter" id="likes" value="likes"
             th:checked="${param.sort != null && param.sort[0] == 'likes'}">
      <span class="text-sm">Likes</span>
    </label>
    <label class="flex items-center gap-1">
      <input type="radio" name="filter" id="deleted" value="deleted"
             th:checked="${param.sort != null && param.sort[0] == 'deleted'}">
      <span class="text-sm">Deleted</span>
    </label>
    <label class="flex items-center gap-1">
      <input type="radio" name="filter" id="category" value="category"
             th:checked="${param.category != null}">
      <span class="text-sm">Category</span>
      <select id="categorySelect" class="ml-1 text-sm px-2 py-1 border rounded"
              th:style="${param.category != null} ? 'display: inline-block' : 'display: none'">
        <option th:each="category : ${categories}" th:value="${category}" th:text="${category}"
                th:selected="${param.category != null && param.category[0] == #strings.toString(category)}">
        </option>
      </select>
    </label>
    <label class="flex items-center gap-1">
      <input type="radio" name="filter" id="custom" value="custom">
      <span class="text-sm">Custom</span>
    </label>
    <button type="submit"
            class="px-4 py-2 bg-tickethub text-white rounded hover:bg-tickethub-dark text-sm">조회
    </button>
    <a href="/admin/performances/create"
       class="px-4 py-2 bg-tickethub text-white rounded hover:bg-tickethub-dark text-sm">등록</a>
  </form>

  <div class="overflow-x-auto">
    <table class="min-w-full table-auto border text-sm">
      <thead class="bg-gray-100">
      <tr>
        <th class="px-3 py-2 border">Image</th>
        <th class="px-3 py-2 border">Title</th>
        <th class="px-3 py-2 border">Category</th>
        <th class="px-3 py-2 border">Place</th>
        <th class="px-3 py-2 border">Start Time</th>
        <th class="px-3 py-2 border">End Time</th>
        <th class="px-3 py-2 border">Reservation Time</th>
        <th class="px-3 py-2 border">Reservation Status</th>
        <th class="px-3 py-2 border"></th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="performance : ${performances}" class="text-center">
        <td class="px-2 py-2 border">
          <img th:src="@{{url}(url=${performance.getUrl()})}" alt="no image"
               class="w-24 h-auto mx-auto"/>
        </td>
        <td class="px-2 py-2 border">
          <a th:href="@{/admin/performances/{performanceId}(performanceId=${performance.id})}"
             th:text="${performance.title}" class="text-blue-600 hover:underline"></a>
        </td>
        <td th:text="${performance.category}" class="px-2 py-2 border"></td>
        <td th:text="${performance.place}" class="px-2 py-2 border"></td>
        <td th:text="${#temporals.format(performance.startTime, 'yyyy-MM-dd HH:mm')}"
            class="px-2 py-2 border"></td>
        <td th:text="${#temporals.format(performance.endTime, 'yyyy-MM-dd HH:mm')}"
            class="px-2 py-2 border"></td>
        <td th:text="${#temporals.format(performance.reservationStartTime, 'yyyy-MM-dd HH:mm')}"
            class="px-2 py-2 border"></td>
        <td th:text="${performance.performanceStatus} ? '예매 가능' : '예매 불가'"
            class="px-2 py-2 border"></td>
        <td class="px-2 py-2 border">
          <a th:href="@{/admin/performances/update/{performanceId}(performanceId=${performance.id})}"
             class="bg-tickethub px-2 py-1 rounded text-sm text-white hover:bg-tickethub-dark"
             th:if="${!(param.sort != null and param.sort[0] == 'deleted')}">수정</a>
        </td>
        <td>
          <a th:href="@{/admin/performances/book/{performanceId}(performanceId=${performance.id})}"
             class="btn btn-warning"
             th:if="${!(param.sort != null and param.sort[0] == 'deleted')}">예매 내역 조회</a>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="mt-6 flex justify-center gap-2" th:if="${totalPage > 1}">
    <a th:href="@{|/admin/performances${baseQuery}&page=0|}"
       th:style="${currentPage > 0} ? '' : 'display:none;'"
       class="px-3 py-1 border rounded">&laquo;</a>
    <a th:href="@{|/admin/performances${baseQuery}&page=${currentPage - 1}|}"
       th:style="${currentPage > 0} ? '' : 'display:none;'"
       class="px-3 py-1 border rounded">&lt;</a>
    <a th:each="i : ${#numbers.sequence(currentPage <= 2 ? 0 : (currentPage + 2 >= totalPage ? totalPage - 5 : currentPage - 2), currentPage <= 2 ? (totalPage < 5 ? totalPage - 1 : 4) : (currentPage + 2 >= totalPage ? totalPage - 1 : currentPage + 2))}"
       th:href="@{|/admin/performances${baseQuery}&page=${i}|}"
       th:text="${i + 1}"
       th:classappend="${i == currentPage} ? ' bg-tickethub text-white' : ''"
       class="px-3 py-1 border rounded"></a>
    <a th:href="@{|/admin/performances${baseQuery}&page=${currentPage + 1}|}"
       th:style="${currentPage < totalPage - 1} ? '' : 'display:none;'"
       class="px-3 py-1 border rounded">&gt;</a>
    <a th:href="@{|/admin/performances${baseQuery}&page=${totalPage - 1}|}"
       th:style="${currentPage < totalPage - 1} ? '' : 'display:none;'"
       class="px-3 py-1 border rounded">&raquo;</a>
  </div>
</div>

<script>
  document.querySelectorAll("input[name='filter']").forEach(input => {
    input.addEventListener("change", () => {
      const selected = input.value;
      document.getElementById("categorySelect").style.display = (selected === "category")
          ? "inline-block" : "none";
    });
  });

  document.getElementById("filterForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const selected = document.querySelector("input[name='filter']:checked").value;
    let url = "/admin/performances?";

    if (["latest", "likes", "deleted"].includes(selected)) {
      url += `sort=${selected}`;
    } else if (selected === "category") {
      const category = document.getElementById("categorySelect").value;
      url += `category=${category}`;
    }
    window.location.href = url;
  });
</script>
</body>
</html>
