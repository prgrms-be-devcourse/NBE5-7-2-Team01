<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>공연 목록 조회</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen py-10 px-4">
<div class="max-w-6xl mx-auto">
  <h1 class="text-3xl font-bold text-center text-orange-500 mb-8">공연 목록 조회</h1>

  <div class="bg-white shadow-md rounded-xl p-6">
    <form method="get" action="/performances" class="flex flex-wrap gap-4 mb-6">
      <input type="text" name="search" placeholder="공연 제목으로 검색"
             class="flex-grow border rounded px-4 py-2"
             th:value="${param.search}"/>
      <button type="submit"
              class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded">
        검색
      </button>
    </form>

    <form id="filterForm" class="flex flex-wrap items-center gap-4">
      <label class="flex items-center gap-2">
        <input type="radio" name="filter" value="latest" checked>
        최신순
      </label>
      <label class="flex items-center gap-2">
        <input type="radio" name="filter" value="likes">
        좋아요순
      </label>
      <label class="flex items-center gap-2">
        <input type="radio" name="filter" value="category">
        카테고리
        <select id="categorySelect" class="ml-2 hidden border rounded px-2 py-1">
          <option disabled selected>선택</option>
          <option th:each="category : ${categories}" th:value="${category}" th:text="${category}"></option>
        </select>
      </label>
      <label class="flex items-center gap-2">
        <input type="radio" name="filter" value="custom" data-toggle="modal" data-target="#customDateModal">
        사용자 지정
      </label>

      <button type="submit" class="ml-auto bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">
        조회
      </button>
    </form>
  </div>

  <div class="bg-white shadow-md rounded-xl p-6 mt-10">
    <div class="overflow-x-auto">
      <table class="table-auto w-full border-collapse">
        <thead>
        <tr class="bg-gray-200">
          <th class="p-2">Image</th>
          <th class="p-2">Title</th>
          <th class="p-2">Category</th>
          <th class="p-2">Place</th>
          <th class="p-2">Start Time</th>
          <th class="p-2">End Time</th>
          <th class="p-2">Reservation Time</th>
          <th class="p-2">Reservation Status</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="performance : ${performances}" class="hover:bg-gray-50">
          <td class="p-2">
            <div class="relative w-24">
              <img th:src="@{{url}(url=${performance.getUrl()})}"
                   alt="no image"
                   class="w-full h-auto rounded object-cover">
              <button class="like-button absolute bottom-1 right-1 text-red-500 text-xl"
                      th:data-id="${performance.id}"
                      th:text="${likedPerformanceIds.contains(performance.id)} ? '♥' : '♡'">
              </button>
            </div>
          </td>
          <td>
            <a th:href="@{/performances/{performanceId}(performanceId=${performance.id})}"
               th:text="${performance.title}" class="text-blue-600 hover:underline"></a>
          </td>
          <td class="p-2" th:text="${performance.category}"></td>
          <td class="p-2" th:text="${performance.place}"></td>
          <td class="p-2" th:text="${#temporals.format(performance.startTime, 'yyyy-MM-dd HH:mm')}"></td>
          <td class="p-2" th:text="${#temporals.format(performance.endTime, 'yyyy-MM-dd HH:mm')}"></td>
          <td class="p-2" th:text="${#temporals.format(performance.reservationStartTime, 'yyyy-MM-dd HH:mm')}"></td>
          <td class="p-2" th:text="${performance.performanceStatus} ? '예매 가능' : '예매 불가'"></td>
        </tr>
        </tbody>
      </table>
    </div>

    <div class="mt-10 flex justify-center space-x-2" th:if="${totalPage > 1}">
      <a th:href="@{|/performances${baseQuery}&page=0|}"
         th:classappend="${currentPage > 0} ? '' : 'invisible'"
         class="px-3 py-1 border rounded">&laquo;</a>
      <a th:href="@{|/performances${baseQuery}&page=${currentPage - 1}|}"
         th:classappend="${currentPage > 0} ? '' : 'invisible'"
         class="px-3 py-1 border rounded">&lt;</a>
      <a th:each="i : ${#numbers.sequence(currentPage <= 2 ? 0 : (currentPage + 2 >= totalPage ? totalPage - 5 : currentPage - 2), currentPage <= 2 ? (totalPage < 5 ? totalPage - 1 : 4) : (currentPage + 2 >= totalPage ? totalPage - 1 : currentPage + 2))}"
         th:href="@{|/performances${baseQuery}&page=${i}|}"
         th:text="${i + 1}"
         th:classappend="${i == currentPage} ? 'bg-orange-500 text-white' : 'hover:bg-gray-100'"
         class="px-3 py-1 border rounded"></a>
      <a th:href="@{|/performances${baseQuery}&page=${currentPage + 1}|}"
         th:classappend="${currentPage < totalPage - 1} ? '' : 'invisible'"
         class="px-3 py-1 border rounded">&gt;</a>
      <a th:href="@{|/performances${baseQuery}&page=${totalPage - 1}|}"
         th:classappend="${currentPage < totalPage - 1} ? '' : 'invisible'"
         class="px-3 py-1 border rounded">&raquo;</a>
    </div>
  </div>
</div>

<script>
  $("input[name='filter']").on("change", function () {
    const selected = $(this).val();
    if (selected === "custom") {
      $('#customDateModal').modal('show');
    } else if (selected === "category") {
      $("#categorySelect").show();
    } else {
      $("#categorySelect").hide();
    }
  });

  $("#filterForm").on("submit", function (e) {
    e.preventDefault();
    const selected = $("input[name='filter']:checked").val();
    let url = "/performances?";
    if (selected === "latest" || selected === "likes") {
      url += `sort=${selected}`;
    } else if (selected === "category") {
      const category = $("#categorySelect").val();
      url += `category=${category}`;
    }
    location.href = url;
  });

  $(document).on("click", ".like-button", function () {
    const $btn = $(this);
    const performanceId = $btn.data("id");
    $.ajax({
      type: "POST",
      url: "/user/like",
      contentType: "application/json",
      data: JSON.stringify({ performanceId }),
      success: function () {
        $btn.text($btn.text().trim() === "♡" ? "♥" : "♡");
      },
      error: function () {
        alert("좋아요 처리 중 오류가 발생했습니다.");
      }
    });
  });
</script>
</body>
</html>
