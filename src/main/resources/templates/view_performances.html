<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>공연 목록 조회</title>
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <style>
    .content-box {
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 20px;
      position: relative;
    }

    .filter-form-container {
      position: absolute;
      top: 20px;
      right: 20px;
    }

    .performance-table {
      margin-top: 80px;
    }

    .like-button {
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 50%;
      line-height: 1;
      transition: background-color 0.2s ease;
    }

    .like-button:hover {
      background-color: #c82333;
    }

    .pagination-container {
      margin-top: 30px;
      display: flex;
      justify-content: center;
    }

    .custom-button {
      background-color: #444;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .custom-button:hover {
      background-color: #333;
    }

    .pagination-container a {
      text-decoration: none;
      color: #444;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background-color: #fff;
      min-width: 30px;
      text-align: center;
      display: inline-block;
      transition: background-color 0.2s;
    }

    .pagination-container a:hover {
      background-color: #e9e9e9;
    }

    .pagination-container a.button {
      background-color: #444;
      color: white;
      pointer-events: none;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <h1 class="text-center mb-4">공연 목록 조회</h1>
  <div class="content-box">
    <div class="filter-form-container">
      <form id="filterForm" class="mb-4">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="filter" id="latest" value="latest"
                 checked>
          <label class="form-check-label" for="latest">최신순</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="filter" id="likes" value="likes">
          <label class="form-check-label" for="likes">좋아요순</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="filter" id="category" value="category">
          <label class="form-check-label" for="category">카테고리</label>
          <select id="categorySelect" class="ml-2" style="display: none;">
            <option th:each="category : ${categories}" th:value="${category}" th:text="${category}">
              선택
            </option>
          </select>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="filter" id="custom" value="custom"
                 data-toggle="modal" data-target="#customDateModal">
          <label class="form-check-label" for="custom">사용자 지정</label>
        </div>

        <div id="customDateFields" class="mt-2" style="display: none;">
          <label>시작 시간:
            <input type="datetime-local" id="startDate" name="startDate"
                   class="form-control d-inline-block w-auto ml-1">
          </label>
          <label class="ml-3">종료 시간:
            <input type="datetime-local" id="endDate" name="endDate"
                   class="form-control d-inline-block w-auto ml-1">
          </label>
        </div>
        <button type="submit" class="custom-button mt-3">조회</button>
      </form>
    </div>

    <div class="performance-table">
      <table class="table table-striped">
        <thead>
        <tr>
          <th>Image</th>
          <th>Title</th>
          <th>Category</th>
          <th>Place</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Reservation Time</th>
          <th>Reservation Status</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="performance : ${performances}">
          <td>
            <div class="image-wrapper" style="position: relative; width: 100px;">
              <img th:src="@{{url}(url=${performance.getUrl()})}"
                 alt="no image"
                 style="width: 100px; height: auto; object-fit: cover;"/>

              <button class="like-button btn btn-sm btn-danger"
                      style="position: absolute; bottom: 5px; right: 5px;"
                      th:data-id="${performance.id}"
                      th:text="${likedPerformanceIds.contains(performance.id)} ? '♥' : '♡'">
              </button>
            </div>
          </td>
          <td th:text="${performance.title}"></td>
          <td th:text="${performance.category}"></td>
          <td th:text="${performance.place}"></td>
          <td th:text="${#temporals.format(performance.startTime, 'yyyy-MM-dd HH:mm')}"></td>
          <td th:text="${#temporals.format(performance.endTime, 'yyyy-MM-dd HH:mm')}"></td>
          <td th:text="${#temporals.format(performance.reservationStartTime, 'yyyy-MM-dd HH:mm')}"></td>
          <td th:text="${performance.performanceStatus} ? '예매 가능' : '예매 불가'"></td>
        </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-container" th:if="${totalPage > 1}">
      <div style="display: flex; gap: 6px; flex-wrap: wrap; min-height: 40px;">
        <a th:href="@{|/performances${baseQuery}&page=0|}"
           th:style="${currentPage > 0} ? 'visibility: visible;' : 'visibility: hidden;'"
           class="custom-pagination">&laquo;</a>

        <a th:href="@{|/performances${baseQuery}&page=${currentPage - 1}|}"
           th:style="${currentPage > 0} ? 'visibility: visible;' : 'visibility: hidden;'"
           class="custom-pagination">&lt;</a>

        <a th:each="i : ${#numbers.sequence(
            currentPage <= 2 ? 0 : (currentPage + 2 >= totalPage ? totalPage - 5 : currentPage - 2),
            currentPage <= 2 ? (totalPage < 5 ? totalPage - 1 : 4) : (currentPage + 2 >= totalPage ? totalPage - 1 : currentPage + 2))}"
           th:href="@{|/performances${baseQuery}&page=${i}|}"
           th:text="${i + 1}"
           th:classappend="${i == currentPage} ? ' button' : ''"
           class="custom-pagination"></a>

        <a th:href="@{|/performances${baseQuery}&page=${currentPage + 1}|}"
           th:style="${currentPage < totalPage - 1} ? 'visibility: visible;' : 'visibility: hidden;'"
           class="custom-pagination">&gt;</a>

        <a th:href="@{|/performances${baseQuery}&page=${totalPage - 1}|}"
           th:style="${currentPage < totalPage - 1} ? 'visibility: visible;' : 'visibility: hidden;'"
           class="custom-pagination">&raquo;</a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="customDateModal" tabindex="-1" role="dialog"
     aria-labelledby="customDateModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content rounded-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="customDateModalLabel">사용자 지정 날짜 선택</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="닫기">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label for="modalStartDate">시작 시간</label>
          <input type="datetime-local" class="form-control" id="modalStartDate">
        </div>
        <div class="form-group">
          <label for="modalEndDate">종료 시간</label>
          <input type="datetime-local" class="form-control" id="modalEndDate">
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-primary" id="customDateApply">조회</button>
      </div>
    </div>
  </div>
</div>

<script>
  $("input[name='filter']").on("change", function () {
    const selected = $(this).val();
    $("#categorySelect").hide();

    if (selected === "custom") {
      $('#customDateModal').modal('show');
    } else if (selected === "category") {
      $("#categorySelect").show();
    }
  });

  $("#filterForm").on("submit", function (e) {
    e.preventDefault();

    const selected = $("input[name='filter']:checked").val();
    let url = "/performances?";

    if (selected === "latest" || selected === "likes") {
      url += `sort=${selected}`;
      location.href = url;
    } else if (selected === "category") {
      const category = $("#categorySelect").val();
      url += `category=${category}`;
      location.href = url;
    }
  });

  $("#customDateApply").on("click", function () {
    const startDate = $("#modalStartDate").val();
    const endDate = $("#modalEndDate").val();

    if (!startDate || !endDate) {
      alert("시작 시간과 종료 시간을 모두 입력하세요.");
      return;
    }

    const url = `/performances?startDate=${encodeURIComponent(
        startDate)}&endDate=${encodeURIComponent(endDate)}`;
    location.href = url;
  });

  $(document).on("click", ".like-button", function () {
    const $btn = $(this);
    const performanceId = $btn.data("id");

    $.ajax({
      type: "POST",
      url: "/user/like",
      contentType: "application/json",
      data: JSON.stringify({
        userId: 1,
        performanceId: performanceId
      }),
      success: function (response) {
        // ♥ / ♡ 토글
        const current = $btn.text().trim();
        $btn.text(current === "♡" ? "♥" : "♡");
      },
      error: function () {
        alert("좋아요 처리 중 오류가 발생했습니다.");
      }
    });
  });
</script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
